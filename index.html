<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego de Plataformas</title>
    <style>
        canvas {
            background: #f0f0f0;
            width: 100vw;
            height: 100vh;
            display: block;
        }
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;

        const player = {
            x: 0,
            y: canvas.height - 100,
            width: 80,
            height: 80,
            isMoving: false,
            isMovingLeft: false,
            isAttacking: false,
            isJumping: false,
            walkSpeed: 11,
            jumpHeight: 300,
            diagonalSpeed: 8,
            velocityX: 0,
            maxVelocityX: 8,
            velocityY: 0,
            gravity: 0.8,
            maxFallSpeed: 15,
            isOnGround: true
        };

        const platforms = [];
        const platformCount = 200; // Número de plataformas

        const loadedImages = {
            quiet: {
                left: [],
                right: []
            },
            walk: {
                left: [],
                right: []
            },
            jump: {
                left: [],
                right: []
            },
            attack: {
                left: [],
                right: []
            }
        };

        let currentFrame = -1;
        let frameCount = 0;
        const staggerFrames = 10;
        const ATTACK_STAGGER = 5;
        let previousImage = null;

        const keys = {
            d: false,
            a: false,
            w: false,
            ShiftLeft: false,
            n: false
        };

        const MOVEMENT_SPEED = 6;
        const GRAVITY = 10;
        const JUMP_FORCE = -25;
        const MAX_FALL_SPEED = 20;

        const GRAVITY_UP = 1.2;    // Base de gravedad para subida
        const GRAVITY_DOWN = 1.2;  // Base de gravedad para caída
        const INITIAL_JUMP_VELOCITY = -25;  // Reducimos la velocidad inicial para menos altura
        const HORIZONTAL_BOOST = 1.8; // Factor de impulso horizontal durante el salto

        let saltando = false;

        // Solo mostrar logs cuando hay cambios significativos
        let ultimoEstadoSuelo = false;
        let tiempoUltimoCambio = 0;
        const TIEMPO_MINIMO_CAMBIO = 100; // milisegundos

        let mostrarHitboxes = true;

        let isAttackAnimationComplete = true; // Para controlar si la animación terminó
        let attackFrame = 0; // Para contar los frames del ataque
        const ATTACK_FRAMES = 6; // Número total de frames en la animación de ataque

        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });
        }

        async function loadAllImages() {
            const quietPathsRight = [
                'spirtessepardes/spritequieto/quieto1.png',
                'spirtessepardes/spritequieto/quieto2.png',
                'spirtessepardes/spritequieto/quieto3.png',
                'spirtessepardes/spritequieto/quieto4.png'
            ];
            const quietPathsLeft = [
                'spirtessepardes/spritequieto/quietoIzquierdaa1.png',
                'spirtessepardes/spritequieto/quietoIzquierdaa2.png',
                'spirtessepardes/spritequieto/quietoIzquierdaa3.png',
                'spirtessepardes/spritequieto/quietoIzquierdaa4.png'
            ];
            const walkPathsRight = [
                'spirtessepardes/spriteCaminar/caminar1.png',
                'spirtessepardes/spriteCaminar/caminar2.png',
                'spirtessepardes/spriteCaminar/caminar3.png',
                'spirtessepardes/spriteCaminar/caminar4.png',
                'spirtessepardes/spriteCaminar/caminar5.png',
                'spirtessepardes/spriteCaminar/caminar6.png',
               
            ];
            const walkPathsLeft = [
                'spirtessepardes/spriteCaminar/caminarIzquierda1.png',
                'spirtessepardes/spriteCaminar/caminarIzquierda2.png',
                'spirtessepardes/spriteCaminar/caminarIzquierda3.png',
                'spirtessepardes/spriteCaminar/caminarIzquierda4.png',
                'spirtessepardes/spriteCaminar/caminarIzquierda5.png',
                'spirtessepardes/spriteCaminar/caminarIzquierda6.png',
            ];

            const jumpPathsRight = [
                'spirtessepardes/spriteSalto/saltoderecha1.png',
                'spirtessepardes/spriteSalto/saltoderecha2.png',
                'spirtessepardes/spriteSalto/saltoderecha3.png',
                'spirtessepardes/spriteSalto/saltoderecha4.png',
                'spirtessepardes/spriteSalto/saltoderecha5.png',
                'spirtessepardes/spriteSalto/saltoderecha6.png',
                'spirtessepardes/spriteSalto/saltoderecha7.png',
                'spirtessepardes/spriteSalto/saltoderecha8.png',

            ];  
            const jumpPathsLeft = [
                'spirtessepardes/spriteSalto/saltoizquierda1.png',
                'spirtessepardes/spriteSalto/saltoizquierda2.png',
                'spirtessepardes/spriteSalto/saltoizquierda3.png',
                'spirtessepardes/spriteSalto/saltoizquierda4.png',
                'spirtessepardes/spriteSalto/saltoizquierda5.png',
                'spirtessepardes/spriteSalto/saltoizquierda6.png',
                'spirtessepardes/spriteSalto/saltoizquierda7.png',
                'spirtessepardes/spriteSalto/saltoizquierda8.png',
            ];
            const attackPathsRight = [
                'spirtessepardes/spriteAtacar/atacarderecha1.png',
                'spirtessepardes/spriteAtacar/atacarderecha2.png',
                'spirtessepardes/spriteAtacar/atacarderecha3.png',
                'spirtessepardes/spriteAtacar/atacarderecha4.png',
                'spirtessepardes/spriteAtacar/atacarderecha5.png',
                'spirtessepardes/spriteAtacar/atacarderecha6.png',
                
            ];
            const attackPathsLeft = [
                'spirtessepardes/spriteAtacar/atacarizquierda1.png',
                'spirtessepardes/spriteAtacar/atacarizquierda2.png',
                'spirtessepardes/spriteAtacar/atacarizquierda3.png',
                'spirtessepardes/spriteAtacar/atacarizquierda4.png',
                'spirtessepardes/spriteAtacar/atacarizquierda5.png',
                'spirtessepardes/spriteAtacar/atacarizquierda6.png',
         
            ];
            for (const path of attackPathsRight) {
                const img = await loadImage(path);
                loadedImages.attack.right.push(img);
            }
            for (const path of attackPathsLeft) {
                const img = await loadImage(path);
                loadedImages.attack.left.push(img);
            }
            for (const path of jumpPathsRight) {
                const img = await loadImage(path);
                loadedImages.jump.right.push(img);
            }
            for (const path of jumpPathsLeft) {
                const img = await loadImage(path);
                loadedImages.jump.left.push(img);
            }
            for (const path of quietPathsRight) {
                const img = await loadImage(path);
                loadedImages.quiet.right.push(img);
            }
            for (const path of quietPathsLeft) {
                const img = await loadImage(path);
                loadedImages.quiet.left.push(img);
            }

            for (const path of walkPathsRight) {
                const img = await loadImage(path);
                loadedImages.walk.right.push(img);
            }
            for (const path of walkPathsLeft) {
                const img = await loadImage(path);
                loadedImages.walk.left.push(img);
            }
        }

        function generatePlatforms() {
            // Limpiar plataformas existentes
            platforms.length = 0;

            // Plataforma base (suelo)
            platforms.push({
                x: 0,
                y: canvas.height - 20,
                width: canvas.width,
                height: 20
            });

            // Crear plataformas en patrón ascendente
            let currentHeight = canvas.height - 150; // Altura inicial
            let alternateLeft = true; // Para alternar entre izquierda y derecha
            
            for (let i = 0; i < 6; i++) { // 6 niveles de plataformas
                let platformWidth = 200; // Ancho fijo para las plataformas
                let x;
                
                if (alternateLeft) {
                    x = canvas.width * 0.2; // 20% desde la izquierda
                } else {
                    x = canvas.width * 0.6; // 60% desde la izquierda
                }

                platforms.push({
                    x: x,
                    y: currentHeight,
                    width: platformWidth,
                    height: 20
                });

                // Ajustar para la siguiente plataforma
                currentHeight -= 150; // Distancia vertical entre plataformas
                alternateLeft = !alternateLeft; // Alternar lado
            }


            // Plataforma superior final
            platforms.push({
                x: canvas.width * 0.4,
                y: 100,
                width: 200,
                height: 20
            });
        }

        function checkCollisions() {
            let isOnAnyPlatform = false;
            let currentPlatformY = canvas.height;
            const COLLISION_MARGIN = 2;

            // Guardamos la posición anterior para debug
            console.log(`Pre-colisión - Y: ${player.y}, VelocityY: ${player.velocityY}`);

            platforms.forEach(platform => {
                const wasAbove = player.y + player.height <= platform.y + COLLISION_MARGIN;
                const willCollide = player.y + player.height + player.velocityY >= platform.y;
                
                if (player.x + player.width > platform.x && 
                    player.x < platform.x + platform.width && 
                    ((wasAbove && willCollide) || 
                     (player.y + player.height >= platform.y - COLLISION_MARGIN && 
                      player.y + player.height <= platform.y + COLLISION_MARGIN))) {
                    
                    isOnAnyPlatform = true;
                    if (platform.y < currentPlatformY) {
                        currentPlatformY = platform.y;
                        player.y = platform.y - player.height;
                        player.velocityY = 0;
                        player.isJumping = false;
                        console.log('Colisión detectada con plataforma');
                    }
                }
            });

            player.isOnGround = isOnAnyPlatform;
            
            if (!isOnAnyPlatform && player.y + player.height > canvas.height) {
                player.y = canvas.height - player.height;
                player.isOnGround = true;
                player.velocityY = 0;
                player.isJumping = false;
                console.log('Colisión con suelo');
            }

            // Debug post-colisión
            console.log(`Post-colisión - Y: ${player.y}, VelocityY: ${player.velocityY}, isJumping: ${player.isJumping}`);
        }

        function updatePlayerPosition() {
            // Movimiento horizontal con boost durante el salto
            if (keys.d && !keys.a) {
                let speed = MOVEMENT_SPEED;
                if (!player.isOnGround) {
                    speed *= HORIZONTAL_BOOST; // Aumentamos velocidad horizontal en el aire
                }
                player.x += speed;
                player.isMoving = true;
                player.isMovingLeft = false;
            } else if (keys.a && !keys.d) {
                let speed = MOVEMENT_SPEED;
                if (!player.isOnGround) {
                    speed *= HORIZONTAL_BOOST; // Aumentamos velocidad horizontal en el aire
                }
                player.x -= speed;
                player.isMoving = true;
                player.isMovingLeft = true;
            } else {
                player.isMoving = false;
            }

            // Lógica de salto
            if (keys.w && player.isOnGround && !player.isJumping) {
                player.velocityY = INITIAL_JUMP_VELOCITY;
                player.isJumping = true;
                player.isOnGround = false;
            }

            // Aplicar gravedad si está en el aire
            if (!player.isOnGround) {
                if (player.velocityY < 0) {
                    // Subida más lineal y rápida
                    player.velocityY += GRAVITY_UP * 0.8;
                } else {
                    // Caída rápida pero controlada
                    if (player.velocityY < 10) {
                        player.velocityY += GRAVITY_DOWN * 0.9;
                    } else {
                        player.velocityY += GRAVITY_DOWN * 1.2;
                    }
                }
            }

            // Limitar velocidad de caída
            if (player.velocityY > 20) { 
                player.velocityY = 20;
            }

            // Actualizar posición vertical
            player.y += player.velocityY;

            // Verificar límites del canvas
            if (player.x < 0) player.x = 0;
            if (player.x + player.width > canvas.width) {
                player.x = canvas.width - player.width;
            }

            // Verificar colisiones
            checkCollisions();
        }

        // Función para manejar el salto
        function handleJump() {
            if (player.isOnGround && !player.isJumping) {
                player.velocityY = JUMP_FORCE;
                player.isJumping = true;
                player.isOnGround = false;
            }
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            updatePlayerPosition();
            
            // Dibujar plataformas
            platforms.forEach(platform => {
                ctx.fillStyle = 'green';
                ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
            });

            frameCount++;
            if (frameCount % (player.isAttacking ? ATTACK_STAGGER : staggerFrames) === 0) {
                if (player.isAttacking) {
                    currentFrame = (currentFrame + 1) % loadedImages.attack.right.length;
                    attackFrame++;
                    
                    // Verificar si la animación de ataque ha terminado
                    if (attackFrame >= ATTACK_FRAMES) {
                        player.isAttacking = false;
                        isAttackAnimationComplete = true;
                        attackFrame = 0;
                        currentFrame = 0;
                    }
                } else if (player.isJumping) {
                    currentFrame = (currentFrame + 1) % loadedImages.jump.right.length;
                } else if (player.isMoving) {
                    currentFrame = (currentFrame + 1) % loadedImages.walk.right.length;
                } else {
                    currentFrame = (currentFrame + 1) % loadedImages.quiet.right.length;
                }
            }

            let currentImage;
            if (player.isAttacking) {
                currentImage = player.isMovingLeft ? 
                    loadedImages.attack.left[currentFrame] : 
                    loadedImages.attack.right[currentFrame];
            } else if (player.isJumping) {
                currentImage = player.isMovingLeft ? 
                    loadedImages.jump.left[currentFrame] : 
                    loadedImages.jump.right[currentFrame];
            } else if (!player.isMovingLeft) {
                currentImage = player.isMoving ? 
                    loadedImages.walk.right[currentFrame] : 
                    loadedImages.quiet.right[currentFrame];
            } else {
                currentImage = player.isMoving ? 
                    loadedImages.walk.left[currentFrame] : 
                    loadedImages.quiet.left[currentFrame];
            }

            if (currentImage) {
                previousImage = currentImage;
                ctx.drawImage(
                    currentImage,
                    player.x,
                    player.y,
                    player.width,
                    player.height
                );
            } else if (previousImage) {
                ctx.drawImage(
                    previousImage,
                    player.x,
                    player.y,
                    player.width,
                    player.height
                );
            }

            requestAnimationFrame(animate);
        }

        document.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() in keys) {
                keys[e.key.toLowerCase()] = true;
                if (e.key.toLowerCase() === 'n' && isAttackAnimationComplete) {
                    player.isAttacking = true;
                    isAttackAnimationComplete = false;
                    attackFrame = 0;
                    currentFrame = 0;
                }
                if (e.key.toLowerCase() === 'a' || e.key.toLowerCase() === 'd') {
                    player.isMoving = true;
                    player.isMovingLeft = (e.key.toLowerCase() === 'a');
                }
            }
            if (e.key.toLowerCase() === 'h') {
                mostrarHitboxes = !mostrarHitboxes;
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.key.toLowerCase() in keys) {
                keys[e.key.toLowerCase()] = false;
                // No necesitamos resetear player.isAttacking aquí
                // ya que se manejará automáticamente cuando termine la animación
            }
        });

        async function startGame() {
            try {
                await loadAllImages();
                generatePlatforms();
                animate();
            } catch (error) {
                console.error('Error cargando imágenes:', error);
            }
        }

        startGame();

        let enSuelo = true;
        const MARGEN_TOLERANCIA = 0.1;

        function estaEnSuelo() {
            // Usar el estado actual si la posición es exactamente igual al suelo
            if (Math.abs(player.y - canvas.height - 20) < MARGEN_TOLERANCIA) {
                enSuelo = true;
                player.y = canvas.height - 20 - player.height; // Forzar posición exacta
                return true;
            }
            
            // Actualizar el estado solo si realmente hay un cambio significativo
            enSuelo = player.y >= canvas.height - 20 - MARGEN_TOLERANCIA;
            
            // Debug
            if (enSuelo !== ultimoEstadoSuelo && 
                Date.now() - tiempoUltimoCambio > TIEMPO_MINIMO_CAMBIO) {
                ultimoEstadoSuelo = enSuelo;
                tiempoUltimoCambio = Date.now();
            }
            
            return enSuelo;
        }

        function actualizarFisica() {
            const ahora = Date.now();
            
            // Aplicar gravedad
            if (!enSuelo) {
                velocidadY += gravedad;
            }
            
            // Actualizar posición
            posicionY += velocidadY;
            
            // Detectar colisión con el suelo con debounce
            if (posicionY >= alturasuelo) {
                posicionY = alturasuelo;
                velocidadY = 0;
                if (!enSuelo && (ahora - ultimoCambioSuelo) > tiempoDebounce) {
                    enSuelo = true;
                    ultimoCambioSuelo = ahora;
                }
            } else if (enSuelo && (ahora - ultimoCambioSuelo) > tiempoDebounce) {
                enSuelo = false;
                ultimoCambioSuelo = ahora;
            }
        }

        function saltar() {
            if (estaEnSuelo()) {
                console.log(`Iniciando salto desde Y: ${player.y}`);
                player.velocityY = -15;
                console.log(`Velocidad inicial de salto: ${player.velocityY}`);
            } else {
                console.log(`Intento de salto fallido - No está en suelo`);
            }
        }

        function dibujarHitboxes() {
            if (!mostrarHitboxes) return;
            
            // Hitbox del jugador
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.strokeRect(player.x, player.y, player.width, player.height);

            // Hitboxes de las plataformas
            ctx.strokeStyle = 'blue';
            platforms.forEach(platform => {
                ctx.strokeRect(platform.x, platform.y, platform.width, platform.height);
            });
        }
    </script>
</body>
</html>